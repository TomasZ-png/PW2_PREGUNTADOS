<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gráfico de Sexo - Admin</title>
</head>
<body>
<h2>Gráfico de Usuarios por Sexo</h2>

<div>
<div id="grafico_sexo" style="width: 900px; height: 500px;"></div>
    <button id="btn-generar-pdf">Descargar PDF</button>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>

    const datosPHP = {{{datosJSON}}};

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(dibujar);

    let chartGlobal;
    let dataGlobal;
    let opcionesGlobal;

    function dibujar() {

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Sexo');
        data.addColumn('number', 'Cantidad');

        for (let key in datosPHP) {
            data.addRow([key, datosPHP[key]]);
        }

        const opciones = {
            title: 'Usuarios Registrados por Sexo',
            pieHole: 0.4
        };

        const chart = new google.visualization.PieChart(
                document.getElementById('grafico_sexo')
        );

        chart.draw(data, opciones);

        chartGlobal = chart;
        dataGlobal = data;
        opcionesGlobal = opciones;
    }

    document.getElementById("btn-generar-pdf").addEventListener("click", () => {

        if (!chartGlobal) {
            alert("El gráfico todavía no terminó de cargarse.");
            return;
        }

        google.visualization.events.addListener(chartGlobal, 'ready', () => {

            const imgURI = chartGlobal.getImageURI();
            const { jsPDF } = window.jspdf;

            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            pdf.addImage(imgURI, 'PNG', 10, 10, 270, 180);
            pdf.save('grafico_sexo.pdf');
        });

        chartGlobal.draw(dataGlobal, opcionesGlobal);
    });

</script>
</body>
</html>
